---
name: 🪟 Windows MinGW Debug Build
on:
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    name: build (mingw-debug)
    runs-on: windows-latest

    steps:
      - name: 🐣 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 🔨 Install MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-declarative
            mingw-w64-x86_64-qt6-location
            mingw-w64-x86_64-qt6-tools
            mingw-w64-x86_64-qt6-3d
            mingw-w64-x86_64-qt6-quick3d
            mingw-w64-x86_64-qt6-positioning
            mingw-w64-x86_64-qt6-svg
            mingw-w64-x86_64-qt6-serialport
            mingw-w64-x86_64-proj
            mingw-w64-x86_64-gdal
            mingw-w64-x86_64-geos
            mingw-w64-x86_64-sqlite3
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-numpy
            mingw-w64-x86_64-python-pyqt6
            mingw-w64-x86_64-flex
            mingw-w64-x86_64-bison
            mingw-w64-x86_64-ccache
            mingw-w64-x86_64-exiv2
            mingw-w64-x86_64-expat
            mingw-w64-x86_64-libspatialindex
            mingw-w64-x86_64-libzip

      - name: 🌱 Configure QGIS Build
        shell: msys2 {0}
        run: |
          # Create build directory
          mkdir -p build
          cd build
          
          # Configure with CMake for Debug build
          cmake .. -G Ninja \
                -D CMAKE_BUILD_TYPE=Debug \
                -D WITH_DESKTOP=ON \
                -D WITH_3D=ON \
                -D WITH_BINDINGS=ON \
                -D ENABLE_TESTS=OFF \
                -D BUILD_WITH_QT6=ON \
                -D ENABLE_UNITY_BUILDS=OFF
          
          # Print out PROJ info to verify
          echo "PROJ information:"
          pkg-config --modversion proj

      - name: 📑 Upload CMake logs (if failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cmake-logs
          path: |
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log

      - name: 🌋 Build QGIS
        shell: msys2 {0}
        run: |
          cd build
          cmake --build . --config Debug

      - name: 📦 Create Debug SDK
        shell: msys2 {0}
        run: |
          # Create SDK directory structure
          mkdir -p sdk/qgis-sdk-debug/bin
          mkdir -p sdk/qgis-sdk-debug/lib
          mkdir -p sdk/qgis-sdk-debug/include
          
          # Copy debug libraries and binaries
          cp -r build/output/bin/* sdk/qgis-sdk-debug/bin/
          cp -r build/output/lib/* sdk/qgis-sdk-debug/lib/
          
          # Create README
          cat > sdk/qgis-sdk-debug/README.md << EOF
          # QGIS Debug SDK
          
          This SDK contains debug builds of QGIS libraries and dependencies.
          Built using GitHub Actions with MinGW.
          
          Created: $(date +%Y-%m-%d)
          EOF
          
          # Create ZIP file
          cd sdk
          zip -r ../qgis-sdk-mingw-debug.zip qgis-sdk-debug

      - name: 📤 Upload debug SDK
        uses: actions/upload-artifact@v4
        with:
          name: qgis-sdk-mingw-debug
          path: |
            qgis-sdk-mingw-debug.zip

      - name: 📤 Upload debug bundle
        uses: actions/upload-artifact@v4
        with:
          name: qgis-mingw-debug
          path: |
            build/*-win64.zip
